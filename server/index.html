<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      #c {
        border: 1px solid palevioletred;
        margin-left: 20%;
      }
    </style>
  </head>

  <body>
    <canvas id="c" width="1000" height="500"></canvas>
    <script>
      window.onload = () => {
        const ws = new WebSocket("ws://192.168.0.164:1337");

        ws.onopen = () => {
          ws.send("klient browser się podłączył");
        };

        ws.onmessage = e => {
          if (e.data[0] != "s") {
            obj = JSON.parse(e.data);
            console.log(obj);
            document.getElementById("nana").style.top = obj.y * 100 + "px";
            document.getElementById("nana").style.left = obj.x * 100 + "px";
            document.getElementById("nana").style.transform =
              "scale(" + obj.z + ", " + obj.z + ")";
          }
        };

        ws.onerror = e => {
          console.log(e.message);
        };

        ws.onclose = e => {
          console.log(e.code, e.reason);
        };

        let innerPath, outerPath, startPath;
        board = () => {
          let c = document.getElementById("c");
          let item = c.getContext("2d");
          let grass_pat, grass_img, road_pat, road_img;

          loadGrassPattern = ctx => {
            (grass_img = new Image()), (url = "img/green.jpg");
            grass_img.src = url;
            grass_img.onload = () => {
              backPattern(item, grass_img);
            };
          };

          backPattern = (ctx, img) => {
            grass_pat = ctx.createPattern(img, "repeat");
            ctx.rect(0, 0, 1000, 500);
            ctx.fillStyle = grass_pat;
            ctx.fill();
            loadRoadPattern();
          };

          loadRoadPattern = ctx => {
            (road_img = new Image()), (url = "img/road.jpg");
            road_img.src = url;
            road_img.onload = () => {
              roadPattern(item, road_img);
            };
          };

          roadPattern = (ctx, img) => {
            road_pat = ctx.createPattern(img, "repeat");
            drawOuter(item, road_pat);
          };

          drawOuter = (ctx, pat) => {
            outerPath = new Path2D();
            outerPath.arc(750, 250, 250, (3 / 2) * Math.PI, (5 / 2) * Math.PI);
            outerPath.arc(250, 250, 250, (5 / 2) * Math.PI, (3 / 2) * Math.PI);
            outerPath.closePath();
            ctx.fillStyle = pat;
            ctx.strokeStyle = "black";
            ctx.stroke(outerPath);
            ctx.fill(outerPath);
            ctx.closePath();
            drawInner(item, grass_pat);
          };

          drawInner = (ctx, pat) => {
            innerPath = new Path2D();
            innerPath.arc(750, 250, 100, (3 / 2) * Math.PI, (5 / 2) * Math.PI);
            innerPath.arc(250, 250, 100, (5 / 2) * Math.PI, (3 / 2) * Math.PI);
            innerPath.closePath();
            ctx.fillStyle = pat;
            ctx.stroke(innerPath);
            ctx.fill(innerPath);
            ctx.moveTo(250, 450);
            ctx.closePath();
          };

          loadGrassPattern();
        };

        player = () => {
          let x = 250;
          let y = 450;
          let angle = 0;
          let flag = false;
          let line = document.getElementById("c").getContext("2d");

          makePlayer = ctx => {
            ctx.beginPath();
            document.addEventListener("keypress", () => start(ctx));
          };

          start = (ctx, e) => {
            alert("press space to start");
            if (e.which == 32) {
              document.removeEventListener("keypress");
              movePlayer(ctx);
            }
          };

          movePlayer = ctx => {
            move = setInterval(() => {
              if (typeof obj !== "undefined") {
                obj.y > 0 ? (y -= Math.sin(obj.y)) : (y += Math.sin(obj.y));
                obj.x < 0 ? (x -= Math.cos(obj.x)) : (x += Math.cos(obj.x));
              } else {
                alert("obj is undefined");
              }
              if (ctx.isPointInPath(innerPath, x, y)) {
                clearInterval(move);
                alert("game over");
                location = location;
              } else if (ctx.isPointInPath(outerPath, x, y) == false) {
                clearInterval(move);
                alert("game over");
                location = location;
              }
              ctx.lineTo(x, y);
              ctx.stroke();
            }, 7);
          };

          makePlayer(line);
        };

        board(), player();
      };
    </script>
  </body>
</html>
